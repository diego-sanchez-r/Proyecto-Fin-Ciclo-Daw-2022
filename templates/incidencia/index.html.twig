{% extends 'base.html.twig' %}

{% block title %}Hello IncidenciaController!{% endblock %}

{% block body %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.8.2/css/lightbox.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.8.2/js/lightbox.min.js"></script>
    
    <style>
        .contenedor {
            padding: 60px;
            width: 87%;
            max-width: 100%;
            margin: 0 auto; 
        }
    a {
        text-decoration: none;
    }

    /* Card Styles */

    .card-sl {
        border-radius: 8px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }

    .card-image img {
        max-height: 100%;
        max-width: 100%;
        border-radius: 8px 8px 0px 0;
    }

    .card-action {
        position: relative;
        float: right;
        margin-top: -25px;
        margin-right: 20px;
        z-index: 2;
        color: #DC3545;
        background: #fff;
        border-radius: 100%;
        padding: 15px;
        font-size: 15px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.19);
    }

    .card-action:hover {
        color: #fff;
        background: #DC3545;
        -webkit-animation: pulse 1.5s infinite;
    }

    .card-heading {
        font-size: 18px;
        font-weight: bold;
        background: #fff;
        padding: 10px 15px;
    }

    .card-text {
        padding-left:15px;
        padding-right:15px;
        background: #fff;
        font-size: 14px;
        color: #636262;
    }

    .card-button {
        display: flex;
        justify-content: center;
        padding: 10px 0;
        width: 100%;
        background-color: #1F487E;
        color: #fff;
        border-radius: 0 0 8px 8px;
    }

    .card-button:hover {
        text-decoration: none;
        background-color: #1D3461;
        color: #fff;

    }


    @-webkit-keyframes pulse {
        0% {
            -moz-transform: scale(0.9);
            -ms-transform: scale(0.9);
            -webkit-transform: scale(0.9);
            transform: scale(0.9);
        }

        70% {
            -moz-transform: scale(1);
            -ms-transform: scale(1);
            -webkit-transform: scale(1);
            transform: scale(1);
            box-shadow: 0 0 0 50px rgba(90, 153, 212, 0);
        }

        100% {
            -moz-transform: scale(0.9);
            -ms-transform: scale(0.9);
            -webkit-transform: scale(0.9);
            transform: scale(0.9);
            box-shadow: 0 0 0 0 rgba(90, 153, 212, 0);
        }
    }
    </style>
    {%include 'menu.html.twig' %}
<h2 class="titulo">Incidencias de la Zona</h2>
  
<div class="container-fluid">
    <div class="px-lg-5">
        <div class="row">
            {% if app.user.rolUsuario == "admin_zona" %}
                <span class="text-success">Administrador de Zona</span>
                <div>Estado:<i class="fa-solid fa-square" style="color:yellow;"></i> Iniciada <i class="fa-solid fa-square" style="color:red"></i> En proceso <i class="fa-solid fa-square" style="color: green;"></i> Resuelto</div>
            {% endif %}

            {% for incidencia in mis_incidencias %}
               
            <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                <div class="card-sl">
                    <div class="">
                        <div class="w-100 bg-secondary text-white text-center rounded-3
                            {% if app.user.rolUsuario == "admin_zona" %} {% if incidencia.estado == "Iniciada" %}bg-warning{% endif %}{% if incidencia.estado == "En proceso" %}bg-danger{% endif %}{% if incidencia.estado == "Resuelto" %}bg-success{% endif %}{% endif %}">
                            {% if app.user.rolUsuario == "admin_zona" %}{% if incidencia.estado == "Resuelto" %}<a href="{{ path("ocultar_incidencia",{id:incidencia.id}) }}" class="text-decoration-none text-white " title="Ocultar Incidencia"><i class="fa-solid fa-eye-slash"></i></a>{% endif %}{% endif %}
                            {% if app.user.rolUsuario == "admin_zona" %}{% if incidencia.estado == "Resuelto" %}<a class="text-decoration-none text-white" data-bs-toggle="collapse" href="#collapseExample{{incidencia.id}}" role="button" aria-expanded="false" aria-controls="collapseExample" title="Cambiar Estado"><i class="fa-solid fa-pen-to-square"></i></a>{% endif %}{% endif %}
                            {% if app.user.rolUsuario == "admin_zona" %}{% if incidencia.estado == "En proceso" %}<a class="text-decoration-none text-white" data-bs-toggle="collapse" href="#collapseExample{{incidencia.id}}" role="button" aria-expanded="false" aria-controls="collapseExample" title="Cambiar Estado"><i class="fa-solid fa-pen-to-square"></i></a>{% endif %}{% endif %}
                            {% if app.user.rolUsuario == "admin_zona" %}{% if incidencia.estado == "Iniciada" %}<a class="text-decoration-none text-white" data-bs-toggle="collapse" href="#collapseExample{{incidencia.id}}" role="button" aria-expanded="false" aria-controls="collapseExample" title="Cambiar Estado"><i class="fa-solid fa-pen-to-square"></i></a>{% endif %}{% endif %}
                        </div>
                        <div class="collapse" id="collapseExample{{incidencia.id}}">
                            <form action="{{ path("edit_estado",{id_in:incidencia.id}) }}" method="post">      
                          <div class="input-group">
                              <select class="form-select form-select-sm" name="estado">
                                  <option value="Iniciada" class="bg-warning">Iniciada</option>
                                  <option value="En proceso" class="bg-danger">En proceso</option>
                                  <option value="Resuelto" class="bg-success">Resuelto</option>
                              </select>
                              <button type="sumbit" class="btn btn btn-outline-dark bg-gradien">Cambiar Estado</button>
                          </div>
                        </form>
                       </div>
                    <a href="/imagenes/img_incidencias/{{incidencia.imagen}}" data-lightbox="photos" title="Zoom">
                            <img class="img-fluid card-img-top rounded-bottom" src="/imagenes/img_incidencias/{{incidencia.imagen}}"  style="height: 220px !important;">
                    </a>
                    </div>

                    <a class="card-action" title="Ubicación" data-bs-toggle="offcanvas" 
                       href="#offcanvasExample{{incidencia.id}}-{{incidencia.id}}" role="button" aria-controls="offcanvasExample">
                        <i class="fa-solid fa-location-dot"></i>
                    </a>
                    <div class="card-heading">
                        <a href="{{ path("ver_incidencia",{id:incidencia.id}) }}"class="text-dark" title="Ver Detalles">{{ incidencia.titulo }}</a>
                    </div>
                    <div class="card-text">
                        {{incidencia.descripcion}}<p style="font-size: xx-small;">Descripción</p>
                    </div>
                <div class="card-text">
                       <div class="d-flex align-items-center justify-content-between rounded-pill px-3 py-2 mt-4" style="background-color: #D9D9D9 !important;">
                    <hr>
                    <p class="small mb-0"><span class="font-weight-bold">Tipología:<small class="text-muted">{{incidencia.averia.nombre}}</small></span></p>
                    <div class="badge badge-danger px-3 rounded-pill font-weight-normal bg-warning"><img src="/imagenes/iconos/{{incidencia.averia.nombre}}.svg" height="18px" alt="..." /></div>
                </div>
                <br>
                <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary">Ver</button>
                    {% if app.user.rolUsuario == "admin_zona" %}<button type="button" class="btn btn-sm btn-outline-danger">Borrar</button>{% endif %}
                </div>
                <small class="text-muted">{{incidencia.fechaCreacion | date("d M, Y")}}</small>
                </div>
                </div>
                <br>
                    <a href="#offcanvasExample{{incidencia.id}}" data-bs-toggle="offcanvas" title="Todos los comentarios"  
                       class="card-button text-decoration-none" role="button" aria-controls="offcanvasExample"> 
                        <i class="fa-solid fa-comments"></i>Ver Comentarios
                    </a>
                </div>
                    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample{{incidencia.id}}" aria-labelledby="offcanvasExampleLabel">
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title" id="offcanvasExampleLabel"><i class="fa-solid fa-comment"></i> Comentarios</h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body">
                            <div>
                                {% for comentario in incidencia.comentarios %}
                                    <div class="foto_usuarioComentario" style="background-image: url(/imagenes/img_users/{{ app.user.imagen }})" ></div>
                                    <div class="contenido rounded-pill">
                                    <div class="nombreUsuComentarios fw-bold">{{ app.user.nombre }} {{ app.user.apellidos }}<br></div>
                                    <div class="comentario" >{{comentario.texto}}</div>
                                    </div>
                                    <br>
                                {%  endfor %}
                                <div id="nuevo{{incidencia.id}}">
                                </div>
                                
                                    <div class="input-group">
                                        <input type="text" name="id_inci" hidden value="{{incidencia.id}}" >
                                        <input type="text" name="texto" id="comentario{{incidencia.id}}" class="form-control" placeholder="Comentar..."/>
                                        <button class="btn btn-success" onclick="comentar({{incidencia.id}})">
                                            <i class="fa-solid fa-arrow-up-right-from-square"></i> Enviar
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasExample{{incidencia.id}}-{{incidencia.id}}" aria-labelledby="offcanvasRightLabel">
                        <div class="offcanvas-header">
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>
                        <script>
                            fetch("https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat={{ incidencia.latitud }}&lon={{ incidencia.longitud }}")
                            .then(function(response) {
                                // Si todo sale bien en la promesa se devuelve el json de la respuesta
                                return response.json();
                            })
                            .then(function(myJson) {
                                let town = document.getElementById('town{{incidencia.id}}');
                                let display_name = document.getElementById('display_name{{incidencia.id}}');
                                town.innerHTML = "<i class='fa-solid fa-location-dot text-danger'> </i> "+myJson.address.town+" ("+myJson.address.postcode+")";
                                display_name.innerHTML = " "+myJson.display_name+" ";

                            });
                        </script>
                        <div class="offcanvas-body">
                            <div>
                                <iframe class="card-img-top" src='https://maps.google.com/maps?q={{ incidencia.latitud }},{{ incidencia.longitud }}&hl=es&z=14&amp;output=embed' height="300px" ></iframe>
                                <h2 class="fw-bolder" id="town{{incidencia.id}}" ></h2>
                                <p class="lead fw-normal text-muted mb-0" id="display_name{{incidencia.id}}"></p>
                                <button class="btn btn-success rounded-pill" title="Latitud">Lat: {{ incidencia.latitud }}</button>
                                <button class="btn btn-success rounded-pill" title="Longitud">Long: {{ incidencia.longitud }}</button>
                            </div>
                        </div>
                    </div>
                                
                </div>   
            {%  endfor %}
        </div>
    </div>
</div>
    <script src="/js/ajax-comentarios.js"></script> 
    <script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>
    {%include 'footer.html.twig' %}  
{% endblock %}
